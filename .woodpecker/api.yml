clone:
  git:
    image: woodpeckerci/plugin-git
    settings:
      partial: false   # отключаем partial clone
      depth: 0         # полный клон
      tags: true       # нужны теги для NBGV

steps:
  - name: build
    image: mcr.microsoft.com/dotnet/sdk:9.0
    when:
      event: [cron, manual]
      path: 'backend/*'
    commands:
      - |
        if "true"; then
          echo "Changes in backend detected — running build"
          echo "API build and test"
          cd backend
          dotnet restore PhotoBank.Backend.sln
          dotnet build PhotoBank.Backend.sln --no-restore --configuration Release
          dotnet test PhotoBank.Backend.sln --no-build --configuration Release --filter "FullyQualifiedName~PhotoBank.UnitTests" || echo "API tests failed, ignoring"
        else
          echo "No backend changes — skipping build"
          exit 0
        fi

  - name: publish
    image: docker:24.0.7-cli
    when:
      event: [cron, manual]
      path: 'backend/*'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      DOCKER_USERNAME:
        from_secret: docker_username
      DOCKER_PASSWORD:
        from_secret: docker_password
    commands:
      - |
        if git diff --name-only "${CI_COMMIT_BEFORE_SHA:-HEAD^}" "${CI_COMMIT_SHA:-HEAD}" | grep -q '^backend/'; then
          echo "Changes in backend detected — running build"
          echo "API docker build and push"
          docker version
          docker info
          echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
          docker build -t makhin/photobank-api:latest backend
          docker push makhin/photobank-api:latest
          docker logout
        else
          echo "No backend changes — skipping build"
          exit 0
        fi
