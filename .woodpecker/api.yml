clone:
  git:
    image: woodpeckerci/plugin-git
    settings:
      partial: false   # отключаем partial clone
      depth: 200         # полный клон
      tags: true       # нужны теги для NBGV

steps:
  - name: build
    image: mcr.microsoft.com/dotnet/sdk:9.0
    volumes:
      - '/var/lib/woodpecker-cache/nuget:/root/.nuget-store'
    when:
      event: [cron, manual]
      path: 'backend/**'
    commands:
      - |
          echo "Changes in backend detected — running build"
          echo "API build and test"
          cd backend
          dotnet restore PhotoBank.Backend.sln
          dotnet build PhotoBank.Backend.sln --no-restore --configuration Release
          dotnet test PhotoBank.Backend.sln --no-build --configuration Release --filter "FullyQualifiedName~PhotoBank.UnitTests" || echo "API tests failed, ignoring"

  - name: publish
    image: docker:28.4.0-cli
    when:
      event: [cron, manual]
      path: 'backend/**'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      DOCKER_USERNAME:
        from_secret: docker_username
      DOCKER_PASSWORD:
        from_secret: docker_password
    commands:
      - |
          echo "Changes in backend detected — running build"
          echo "API docker build and push"
          docker version
          docker info
          echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
          docker build -t makhin/photobank-api:latest backend
          docker push makhin/photobank-api:latest
          docker logout

