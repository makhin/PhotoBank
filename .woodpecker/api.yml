kind: pipeline
name: api

clone:
  git:
    image: woodpeckerci/plugin-git
    settings:
      partial: false        # нужен полный клон
      depth: 200              # history + теги для NBGV
      tags: true

# Для volume-кэша нужен trusted-режим для репозитория
volumes:
  - name: nuget-cache
    host:
      path: /var/lib/woodpecker-cache/nuget

steps:
  - name: build
    image: mcr.microsoft.com/dotnet/sdk:9.0-alpine
    when:
      event: [cron, manual]
      path: 'backend/*'
    volumes:
      - name: nuget-cache
        path: /root/.nuget/packages
    commands:
      - |
        echo "Changes in backend detected — running build"
        cd backend
        dotnet restore
        dotnet build -c Release --no-restore
        # dotnet test --no-build  # если есть тесты — раскомментируй

  - name: dockerize
    image: quay.io/thegeeklab/wp-docker-buildx
    privileged: true
    when:
      event: [cron, manual]
      path: 'backend/*'
    settings:
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      repo: makhin/photobank-api
      tags:
        - latest
      context: backend
      containerfile: backend/Dockerfile
      pull_image: true                       # всегда тянуть свежие базовые образы
      provenance: false                      # чуть быстрее пуш
      cache_from:
        - "type=registry,ref=makhin/photobank-api:buildcache"
      cache_to: "type=registry,ref=makhin/photobank-api:buildcache,mode=max"
