steps:
  - name: build
    image: node:20-alpine
    when:
      - event: [push, manual]
      - path: ['frontend/packages/telegram-bot/*', 'frontend/packages/shared/*']
    environment:
      VITE_API_BASE_URL:
        from_secret: vite_api_base_url
    commands:
      - echo "Telegram bot install, build and test"
      - cd frontend
      - corepack enable
      - pnpm install --frozen-lockfile
      - pnpm --filter @photobank/telegram-bot build
      - pnpm --filter @photobank/telegram-bot test || echo "Telegram bot tests failed, ignoring"

  - name: publish
    image: docker:24.0.7-cli
    when:
      - event: [push, manual]
      - path: ['frontend/packages/telegram-bot/*', 'frontend/packages/shared/*']
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      DOCKER_USERNAME:
        from_secret: docker_username
      DOCKER_PASSWORD:
        from_secret: docker_password
    commands:
      - echo "Telegram bot docker build and push"
      - docker version
      - docker info
      - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - docker build -f frontend/Dockerfile.bot -t makhin/photobank-bot:latest frontend
      - docker push makhin/photobank-bot:latest
      - docker logout